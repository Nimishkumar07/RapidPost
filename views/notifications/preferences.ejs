<% layout("layouts/boilerplate") %>

<div class="row">
    <div class="col-md-6 mx-auto">
        <div class="card">
            <div class="card-header">
                <h4><i class="bi bi-gear"></i> Notification Preferences</h4>
                <p class="text-muted mb-0">Choose which notifications you want to receive</p>
            </div>
            <div class="card-body">
                <form id="preferencesForm">
                    <div class="mb-4">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="likesToggle" 
                                   <%= preferences.likes ? 'checked' : '' %>>
                            <label class="form-check-label" for="likesToggle">
                                <strong>Like Notifications</strong>
                                <br>
                                <small class="text-muted">Get notified when someone likes your blog posts</small>
                            </label>
                        </div>
                    </div>

                    <div class="mb-4">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="commentsToggle" 
                                   <%= preferences.comments ? 'checked' : '' %>>
                            <label class="form-check-label" for="commentsToggle">
                                <strong>Comment Notifications</strong>
                                <br>
                                <small class="text-muted">Get notified when someone comments on your blog posts</small>
                            </label>
                        </div>
                    </div>

                    <div class="mb-4">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="followsToggle" 
                                   <%= preferences.follows ? 'checked' : '' %>>
                            <label class="form-check-label" for="followsToggle">
                                <strong>Follow Notifications</strong>
                                <br>
                                <small class="text-muted">Get notified when someone follows you</small>
                            </label>
                        </div>
                    </div>

                    <div class="mb-4">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="newPostsToggle" 
                                   <%= preferences.newPosts ? 'checked' : '' %>>
                            <label class="form-check-label" for="newPostsToggle">
                                <strong>New Post Notifications</strong>
                                <br>
                                <small class="text-muted">Get notified when people you follow publish new posts</small>
                            </label>
                        </div>
                    </div>

                    <hr class="my-4">

                    <div class="mb-4">
                        <h5><i class="bi bi-phone"></i> Push Notifications</h5>
                        <p class="text-muted small">Receive notifications on your device even when you're not using the website</p>
                        
                        <div id="pushNotificationStatus" class="mb-3">
                            <div class="d-flex align-items-center">
                                <span id="pushStatusText" class="me-3">Checking status...</span>
                                <div id="pushStatusSpinner" class="spinner-border spinner-border-sm" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                            </div>
                        </div>
                        
                        <div id="pushNotificationControls" style="display: none;">
                            <button id="enablePushBtn" class="btn btn-success btn-sm me-2" style="display: none;">
                                <i class="bi bi-bell"></i> Enable Push Notifications
                            </button>
                            <button id="disablePushBtn" class="btn btn-outline-danger btn-sm me-2" style="display: none;">
                                <i class="bi bi-bell-slash"></i> Disable Push Notifications
                            </button>
                            <button id="testPushBtn" class="btn btn-outline-primary btn-sm" style="display: none;">
                                <i class="bi bi-send"></i> Send Test Notification
                            </button>
                        </div>
                    </div>

                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-primary" id="saveBtn">
                            <i class="bi bi-check-lg"></i> Save Preferences
                        </button>
                        <a href="/notifications" class="btn btn-outline-secondary">
                            <i class="bi bi-arrow-left"></i> Back to Notifications
                        </a>
                    </div>
                </form>
            </div>
        </div>

        <!-- Success/Error Messages -->
        <div id="messageContainer" class="mt-3" style="display: none;">
            <div id="messageAlert" class="alert" role="alert"></div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('preferencesForm');
    const saveBtn = document.getElementById('saveBtn');
    const messageContainer = document.getElementById('messageContainer');
    const messageAlert = document.getElementById('messageAlert');

    // Auto-save when toggles change
    const toggles = ['likesToggle', 'commentsToggle', 'followsToggle', 'newPostsToggle'];
    
    toggles.forEach(toggleId => {
        document.getElementById(toggleId).addEventListener('change', function() {
            savePreferences();
        });
    });

    form.addEventListener('submit', function(e) {
        e.preventDefault();
        savePreferences();
    });

    // Initialize push notification status
    initPushNotificationStatus();

    function savePreferences() {
        const preferences = {
            likes: document.getElementById('likesToggle').checked,
            comments: document.getElementById('commentsToggle').checked,
            follows: document.getElementById('followsToggle').checked,
            newPosts: document.getElementById('newPostsToggle').checked
        };

        // Show loading state
        saveBtn.disabled = true;
        saveBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> Saving...';

        fetch('/notifications/api/preferences', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ preferences })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showMessage('Preferences saved successfully!', 'success');
            } else {
                showMessage(data.message || 'Failed to save preferences', 'danger');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showMessage('Failed to save preferences', 'danger');
        })
        .finally(() => {
            // Reset button state
            saveBtn.disabled = false;
            saveBtn.innerHTML = '<i class="bi bi-check-lg"></i> Save Preferences';
        });
    }

    function showMessage(message, type) {
        messageAlert.className = `alert alert-${type}`;
        messageAlert.textContent = message;
        messageContainer.style.display = 'block';
        
        // Auto-hide success messages
        if (type === 'success') {
            setTimeout(() => {
                messageContainer.style.display = 'none';
            }, 3000);
        }
    }

    // Push notification functions
    async function initPushNotificationStatus() {
        const statusText = document.getElementById('pushStatusText');
        const statusSpinner = document.getElementById('pushStatusSpinner');
        const controls = document.getElementById('pushNotificationControls');
        const enableBtn = document.getElementById('enablePushBtn');
        const disableBtn = document.getElementById('disablePushBtn');
        const testBtn = document.getElementById('testPushBtn');

        try {
            if (!('serviceWorker' in navigator) || !('PushManager' in window)) {
                statusText.textContent = 'Push notifications not supported in this browser';
                statusSpinner.style.display = 'none';
                return;
            }

            const registration = await navigator.serviceWorker.getRegistration('/sw.js');
            if (!registration) {
                statusText.textContent = 'Service worker not registered';
                statusSpinner.style.display = 'none';
                return;
            }

            const subscription = await registration.pushManager.getSubscription();
            statusSpinner.style.display = 'none';
            controls.style.display = 'block';

            if (subscription) {
                statusText.innerHTML = '<i class="bi bi-check-circle text-success"></i> Push notifications enabled';
                disableBtn.style.display = 'inline-block';
                testBtn.style.display = 'inline-block';
            } else {
                statusText.innerHTML = '<i class="bi bi-x-circle text-warning"></i> Push notifications disabled';
                enableBtn.style.display = 'inline-block';
            }

            // Event listeners
            enableBtn.addEventListener('click', enablePushNotifications);
            disableBtn.addEventListener('click', disablePushNotifications);
            testBtn.addEventListener('click', sendTestPushNotification);

        } catch (error) {
            console.error('Error checking push notification status:', error);
            statusText.textContent = 'Error checking push notification status';
            statusSpinner.style.display = 'none';
        }
    }

    async function enablePushNotifications() {
        try {
            const permission = await Notification.requestPermission();
            if (permission === 'granted') {
                await window.notificationManager.subscribeToPush();
                showMessage('Push notifications enabled successfully!', 'success');
                setTimeout(() => location.reload(), 1000);
            } else {
                showMessage('Push notification permission denied', 'warning');
            }
        } catch (error) {
            console.error('Error enabling push notifications:', error);
            showMessage('Failed to enable push notifications', 'danger');
        }
    }

    async function disablePushNotifications() {
        try {
            const registration = await navigator.serviceWorker.getRegistration('/sw.js');
            const subscription = await registration.pushManager.getSubscription();
            
            if (subscription) {
                await subscription.unsubscribe();
                
                // Notify server
                await fetch('/notifications/api/push/unsubscribe', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ endpoint: subscription.endpoint })
                });
                
                showMessage('Push notifications disabled', 'success');
                setTimeout(() => location.reload(), 1000);
            }
        } catch (error) {
            console.error('Error disabling push notifications:', error);
            showMessage('Failed to disable push notifications', 'danger');
        }
    }

    async function sendTestPushNotification() {
        try {
            const response = await fetch('/notifications/api/push/test', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            });
            
            const data = await response.json();
            
            if (data.success) {
                showMessage('Test notification sent! Check your device.', 'success');
            } else {
                showMessage(data.message || 'Failed to send test notification', 'danger');
            }
        } catch (error) {
            console.error('Error sending test notification:', error);
            showMessage('Failed to send test notification', 'danger');
        }
    }
});
</script>

<style>
.form-check-input:checked {
    background-color: #0d6efd;
    border-color: #0d6efd;
}

.form-check-input:focus {
    border-color: #86b7fe;
    outline: 0;
    box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
}

.card {
    border: none;
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
}

.card-header {
    background-color: #f8f9fa;
    border-bottom: 1px solid #dee2e6;
}
</style>