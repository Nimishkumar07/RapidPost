<% layout('/layouts/boilerplate') %>


<body>
  
<div class="position-relative">
<div class="container py-4" style="max-width: 64rem;">
    <!-- Blog Header -->
    <header class="mb-4 mb-md-5">
      <div class="mb-3">
        <span class="badge rounded-pill bg-primary text-white px-3 py-2"><%= blog.category %></span>
      </div>
      <h1 class="fw-bold text-dark display-5 mb-3"><%= blog.title %></h1>

      <!-- Author Info -->
      <div class="d-flex align-items-center justify-content-between flex-wrap gap-3 mb-4">
        <a href="/users/<%= blog.author._id %>" class="d-flex align-items-center text-decoration-none text-dark">
          <img src="<%= blog.author.avatar.url %>" alt="<%= blog.author.name %>" class="rounded-circle me-3" style="width:48px;height:48px;object-fit:cover;">
          <div>
            <h3 class="h5 fw-semibold mb-1"><%= blog.author.name %></h3>
            <p class="text-muted mb-0"><%= blog.author.bio %></p>
          </div>
        </a>
        <div class="d-flex align-items-center gap-3">
          
            <a href="https://twitter.com/<%= blog.author.socialLinks.twitter %>" target="_blank" rel="noreferrer" class="text-muted hover text-decoration-none">
                <i class="fa-brands fa-x-twitter"></i>
            </a>
          
          
            <a href="https://linkedin.com/in/<%= blog.author.socialLinks.linkedin %>" target="_blank" rel="noreferrer" class="text-muted text-decoration-none">
                <i class="fa-brands fa-linkedin"></i>
            </a>
         
         
            <a href="https://github.com/<%= blog.author.socialLinks.github %>" target="_blank" rel="noreferrer" class="text-muted text-decoration-none">
                <i class="fa-brands fa-square-github"></i>
            </a>
          
        </div>
      </div>

      <!-- Blog Meta -->
      <div class="d-flex align-items-center gap-4 text-muted border-bottom pb-3">
        <span class="d-inline-flex align-items-center">
         <i class="fa-regular fa-calendar me-2"></i>
          <%= new Date(blog.createdAt).toLocaleDateString() %>
        </span>
        <span class="d-inline-flex align-items-center">
          <i class="fa-solid fa-eye me-2"></i>
          <%= Number(blog.views).toLocaleString() %> views
        </span>
        <span class="d-inline-flex align-items-center">
         <i class="fa-regular fa-clock me-2"></i>
          5 min read
        </span>
        <span class="d-inline-flex align-items-center ms-auto">
          <button id="readAloudBtn" type="button" class="btnn-decore btn-link text-muted text-decoration-none p-0 d-inline-flex align-items-center">
            <i id="readAloudIcon" class="fa-solid fa-volume-high me-2"></i> <span id="readAloudText">Read</span>
          </button>
        </span>

      </div>
    </header>

    <!-- Featured Image -->
    <div class="mb-4 mb-md-5">
      <img src="<%= blog.image.url %>" alt="<%= blog.title %>" class="img-fluid rounded-4" style="height: auto; max-height: 28rem; width: 100%; object-fit: cover;">
    </div>

    <!-- Blog Content -->
    <div class="mb-4 mb-md-5">
      <div class="mx-auto" style="max-width: 48rem;">
        <!-- Ensure data.description is sanitized if it contains HTML -->
        <div class="rich-text"><%- blog.description %></div>
      </div>
    </div>

    <!-- Engagement Actions -->
    <div class="d-flex align-items-center justify-content-between border-top border-bottom py-3 mb-4">
      <div class="d-flex align-items-center gap-3">
        <form action="/blogs/<%= blog._id %>/likes" method="post" class="m-0">
          <button type="submit" class=" btnn-decore  btn-link text-decoration-none text-muted p-0 d-inline-flex align-items-center">
            <% if (currUser && blog.likes.includes(currUser._id.toString())) { %>
              <i class="fa-solid fa-heart me-2" style="color: red;"></i>
            <% } else { %>
              <i class="fa-regular fa-heart me-2"></i>
            <% } %>

            <span><%= typeof blog.likes === 'number' ? blog.likes : (blog.likes && blog.likes.length) || 0 %></span>
          </button>
        </form>
        <a href="" class="text-muted text-decoration-none d-inline-flex align-items-center">
          <i class="fa-solid fa-comment me-2"></i>
          <span><%= blog.reviews.length || 0 %></span>
        </a>
      </div>
      <div class="d-flex align-items-center gap-3">
        <button id="shareBtn" type="button" class="btnn-decore btn-link text-muted text-decoration-none p-0 d-inline-flex align-items-center">
          <i class="fa-solid fa-share-nodes me-2"></i>
          Share
        </button>
       <% if (currUser && blog.author._id.toString() !== currUser._id.toString()) { %>
          <form action="/blogs/<%= blog._id %>/save" method="post">
            <button class="btnn-decore btn-link text-muted text-decoration-none p-0 d-inline-flex align-items-center">
              <% if (user && user.savedBlogs && user.savedBlogs.includes(blog._id.toString())) { %>
                <i class="fa-solid fa-bookmark me-2" ></i> Unsave
              <% } else { %>
                <i class="fa-regular fa-bookmark me-2" ></i> Save
              <% } %>
            </button>
          </form>
        <% } %>

      </div>
    </div>

    <!-- Comments Section -->
    <section id="comments" class="mb-5">
      <h3 class="h4 fw-bold text-dark mb-4">Comments</h3>

      <!-- Comment Form -->
       <% if(currUser){ %>
      <div class="card shadow-sm mb-4">
        <div class="card-body">
          <h4 class="h6 fw-semibold mb-3">Leave a comment</h4>
          <form action="/blogs/<%= blog._id %>/reviews" method="post">
            <div class="mb-3">
              <textarea name="review[comment]" rows="4" class="form-control" placeholder="Share your thoughts..." required></textarea>
            </div>
            <div class="d-flex justify-content-between align-items-center">
              
              <button type="submit" class="mb-1 btn btn-primary">Post Comment</button>
            </div>
          </form>
        </div>
      </div>
      <% } %>

      <!-- Comments List -->
       <% if(blog.reviews.length>0) {%>

      <div class="d-flex flex-column gap-3">
        <% for(review of blog.reviews){ %>
          <div class="card shadow-sm">
            <div class="card-body position-relative">
              <div class="d-flex align-items-center gap-3 mb-3">
                <img src="<%= review.author.avatar ? review.author.avatar.url : '/default-avatar.png' %>" alt="<%= review.author.name %>" class="rounded-circle" style="width:40px;height:40px;object-fit:cover;">
                <div>
                  <h4 class="h6 fw-semibold mb-0"><%= review.author.name %></h4>
                  <p class="small text-muted mb-0"><%= new Date(review.createdAt).toLocaleDateString() %></p>
                </div>
              </div>

              <p class="text-dark mb-3"><%= review.comment %></p>

              <div class="position-relative end-0 bottom-0 pe-3 pb-2 text-muted small">
                 <% if(currUser && currUser._id.equals(review.author._id)) { %>
                    <form method="post" action="/blogs/<%= blog._id %>/reviews/<%= review._id %>?_method=DELETE">
                        <button  style="background-color: rgb(211, 77, 77); color: aliceblue;">Delete</button>
                    </form>
                    <% } %>
              </div>

              <div class="position-absolute end-0 bottom-0 pe-3 pb-2 text-muted small">
                <!-- Humanized time; replace with server-side library like moment if needed -->
                <%= moment(review.createdAt).fromNow() %>
              </div>
            </div>
          </div>
        <% } %>
      </div>
     <% } %>
    </section>
  </div>
</div>

<script>
  document.getElementById("shareBtn").addEventListener("click", () => {
    navigator.clipboard.writeText(window.location.href)
      .then(() => {
        alert("Link copied to clipboard!");
      })
      .catch(err => {
        console.error("Failed to copy: ", err);
      });
  });
</script>

<!-- Read Aloud Button -->
<script>
  document.getElementById("shareBtn").addEventListener("click", () => {
    navigator.clipboard.writeText(window.location.href)
      .then(() => {
        alert("Link copied to clipboard!");
      })
      .catch(err => {
        console.error("Failed to copy: ", err);
      });
  });
</script>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const readAloudButton = document.getElementById('readAloudBtn');
    const readAloudIcon = document.getElementById('readAloudIcon');
    const readAloudText = document.getElementById('readAloudText');
    const blogContent = document.querySelector('.rich-text');

    // Check if the browser supports the Speech Synthesis API
    if (!('speechSynthesis' in window)) {
      readAloudButton.style.display = 'none'; // Hide button if not supported
      return;
    }

    let utterance = null;

    function resetUI() {
      readAloudIcon.className = 'fa-solid fa-volume-high me-2';
      readAloudText.textContent = 'Read';
    }

    readAloudButton.addEventListener('click', () => {
      // If currently speaking, stop it
      if (window.speechSynthesis.speaking) {
        window.speechSynthesis.cancel();
        resetUI();
        return;
      }
      
      // If there's no text, do nothing
      if (!blogContent || !blogContent.textContent.trim()) {
          alert('No content to read.');
          return;
      }

      // Create a new speech request
      const textToSpeak = blogContent.textContent;
      utterance = new SpeechSynthesisUtterance(textToSpeak);

      // When speech ends naturally, reset the button UI
      utterance.onend = () => {
        resetUI();
      };

      // If an error occurs, log it and reset UI
      utterance.onerror = (event) => {
        console.error('SpeechSynthesisUtterance.onerror', event);
        resetUI();
      };

      // Start speaking
      window.speechSynthesis.speak(utterance);

      // Update the button UI to show "Stop"
      readAloudIcon.className = 'fa-solid fa-stop me-2';
      readAloudText.textContent = 'Stop';
    });

    // Optional: Ensure speech is cancelled if the user navigates away
    window.addEventListener('beforeunload', () => {
        if (window.speechSynthesis.speaking) {
            window.speechSynthesis.cancel();
        }
    });
  });
</script>

</body>

</body>
